name: CI

on:
  push:
  pull_request:

jobs:
  # -----------------------------------------------
  # PYTHON LINTING (Pylint)
  # -----------------------------------------------
  python-lint:
    name: Python Lint (Pylint)
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: ["3.8", "3.9", "3.10"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pylint

      - name: Run Pylint
        run: |
          echo "Running pylint..."
          pylint $(git ls-files '*.py')

  # -----------------------------------------------
  # GO ENVIRONMENT SETUP
  # -----------------------------------------------
  go-setup:
    name: Setup Go
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.22"
          check-latest: true
          cache: true
          cache-dependency-path: go.sum

      - name: Verify Go installation
        run: go version

  # -----------------------------------------------
  # NODE ENVIRONMENT SETUP
  # -----------------------------------------------
  node-setup:
    name: Setup Node.js
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          check-latest: true
          cache: "npm"

      - name: Verify Node installation
        run: node -v
            - name: Cache
  uses: actions/cache@v4.3.0
  with:
    # A list of files, directories, and wildcard patterns to cache and restore
    path: 
    # An explicit key for restoring and saving the cache
    key: 
    # An ordered multiline string listing the prefix-matched keys that are used for restoring stale cache if no cache hit occurred for key. Note `cache-hit` returns false in this case.
    restore-keys: # optional
    # The chunk size used to split up large files during upload, in bytes
    upload-chunk-size: # optional
    # An optional boolean, when enabled, allows Windows runners to save or restore caches that can be restored or saved respectively on other platforms
    enableCrossOsArchive: # optional, default is false
    # Fail the workflow if the cache entry is not found
    fail-on-cache-miss: # optional, default is false
    # Check if a cache entry exists for the given input(s) (key, restore-keys) without downloading the cache
    lookup-only: # optional, default is false
    # Run the post step to save the cache even if another step before fails
    save-always: # optional, default is false
      name: Monorepo CI

on:
  push:
  pull_request:

# -----------------------------------------------------------
# MATRIX: Automatically selects languages based on directories
# -----------------------------------------------------------
jobs:
  discover:
    name: Detect Changed Stacks
    runs-on: ubuntu-latest

    outputs:
      python: ${{ steps.filter.outputs.python }}
      go: ${{ steps.filter.outputs.go }}
      node: ${{ steps.filter.outputs.node }}

    steps:
      - uses: actions/checkout@v4

      - id: filter
        name: Detect changed stacks
        run: |
          echo "python=$(git diff --name-only HEAD~1 HEAD | grep -q '^python/' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "go=$(git diff --name-only HEAD~1 HEAD | grep -q '^go/' && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "node=$(git diff --name-only HEAD~1 HEAD | grep -q '^node/' && echo true || echo false)" >> $GITHUB_OUTPUT

# -----------------------------------------------------------
# PYTHON JOB
# -----------------------------------------------------------
  python:
    name: Python Build / Test / Lint
    needs: discover
    if: needs.discover.outputs.python == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: python

    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11"]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pylint pytest

      - name: Lint (Pylint)
        run: pylint $(git ls-files '*.py')

      - name: Run Tests
        run: pytest -q

# -----------------------------------------------------------
# GO JOB
# -----------------------------------------------------------
  go:
    name: Go Build / Test / Vet
    needs: discover
    if: needs.discover.outputs.go == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: go

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.22"
          cache: true
          cache-dependency-path: go.sum

      - name: Build
        run: go build ./...

      - name: Go Vet
        run: go vet ./...

      - name: Test
        run: go test ./... -v

# -----------------------------------------------------------
# NODE JOB
# -----------------------------------------------------------
  node:
    name: Node Build / Test / Lint
    needs: discover
    if: needs.discover.outputs.node == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: node

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install Dependencies
        run: npm ci

      - name: Lint
        run: npm run lint --if-present

      - name: Test
        run: npm test --if-present

      - name: Build
        run: npm run build --if-present

# -----------------------------------------------------------
# SUMMARY JOB (OPTIONAL)
# -----------------------------------------------------------
  summary:
    name: Summary
    needs: [python, go, node]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - run: echo "Monorepo CI completed"
/python
   requirements.txt
   source...

/go
   go.mod
   source...

/node
   package.json
   source...

/.github/workflows/ci.yml
name: Monorepo CI — Full (build / test / lint / scan / release / deploy)

# Run for pushes and PRs; release and codeql will also be scheduled or triggered separately
on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * 0'   # weekly CodeQL + dependency scans (optional)

###############################################################################
# 1) DISCOVERY: detect which stacks changed (python/, go/, node/) so we skip
#    jobs that aren't necessary for the current PR/push.
###############################################################################
jobs:
  discover:
    name: Detect Changed Stacks
    runs-on: ubuntu-latest
    outputs:
      python: ${{ steps.detect.outputs.python }}
      go: ${{ steps.detect.outputs.go }}
      node: ${{ steps.detect.outputs.node }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - id: detect
        name: Detect changed stacks (python, go, node)
        run: |
          echo "Detecting changed paths..."
          git fetch --no-tags --prune --unshallow || true
          # If this is a PR, prefer comparing to base ref; fallback to HEAD~1
          BASE="${{ github.event.pull_request.base.sha || '' }}"
          if [ -z "$BASE" ]; then
            BASE="HEAD~1"
          fi
          CHANGED=$(git diff --name-only "$BASE" HEAD || true)
          echo "Changed files:"
          echo "$CHANGED"
          python_changed=false
          go_changed=false
          node_changed=false
          echo "$CHANGED" | grep -E '^python/' && python_changed=true || true
          echo "$CHANGED" | grep -E '^go/' && go_changed=true || true
          echo "$CHANGED" | grep -E '^node/' && node_changed=true || true
          echo "python=$python_changed" >> $GITHUB_OUTPUT
          echo "go=$go_changed" >> $GITHUB_OUTPUT
          echo "node=$node_changed" >> $GITHUB_OUTPUT

###############################################################################
# 2) PYTHON JOB: build, lint (pylint), tests (pytest), coverage upload (Codecov)
###############################################################################
  python:
    name: Python — Lint / Test / Coverage
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.python == 'true'
    defaults:
      run:
        working-directory: python
    strategy:
      matrix:
        python-version: ["3.10"]  # adjust matrix as needed
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pylint pytest pytest-cov pip-audit

      - name: Pre-commit (format & hooks)
        uses: pre-commit/action@v4
        with:
          extra_args: --all-files

      - name: Lint (pylint)
        run: |
          echo "Running pylint..."
          pylint $(git ls-files '*.py') || true

      - name: Run tests with coverage
        env:
          PYTHONWARNINGS: "ignore::DeprecationWarning"
        run: |
          if [ -f pytest.ini ] || [ -d tests ]; then
            pytest --maxfail=1 --disable-warnings -q --cov=.
            pytest_exit=$?
          else
            echo "No tests found"
            pytest_exit=0
          fi
          exit $pytest_exit

      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Python dependency audit (pip-audit)
        run: |
          pip-audit --output text || true

###############################################################################
# 3) GO JOB: build / vet / test / dependency-check
###############################################################################
  go:
    name: Go — Build / Vet / Test / Dep Audit
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.go == 'true'
    defaults:
      run:
        working-directory: go
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.22"
          check-latest: true
          cache: true
          cache-dependency-path: go.sum

      - name: Go build
        run: |
          go env
          go build ./...

      - name: Go vet
        run: go vet ./...

      - name: Run Go tests
        run: go test ./... -v

      - name: Go dependency audit (govulncheck if available)
        run: |
          if command -v govulncheck >/dev/null 2>&1; then
            govulncheck ./...
          else
            echo "govulncheck not installed — skipping. Consider adding it to CI image."
          fi

###############################################################################
# 4) NODE JOB: install / lint / test / build / coverage / deploy artifact
###############################################################################
  node:
    name: Node — Lint / Test / Build / Coverage
    needs: discover
    runs-on: ubuntu-latest
    if: needs.discover.outputs.node == 'true'
    defaults:
      run:
        working-directory: node
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies (npm ci)
        run: |
          npm ci

      - name: Run pre-commit JavaScript checks (optional)
        run: |
          npx --no-install pre-commit run --all-files || true

      - name: Lint (npm run lint)
        run: npm run lint --if-present

      - name: Run tests (npm test)
        run: npm test --if-present

      - name: Build (npm run build)
        run: npm run build --if-present

      - name: Upload node build artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: node-dist
          path: node/dist/

      - name: npm audit (vulnerability check)
        run: npm audit --audit-level=moderate || true

      - name: Upload JS coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

###############################################################################
# 5) DOCKER: build & push image to GitHub Container Registry (GHCR)
#    Requires: repo secret GHCR_PAT or use GITHUB_TOKEN with packages: write permission
###############################################################################
  docker:
    name: Docker Build & Push
    runs-on: ubuntu-latest
    needs: [python, go, node]
    if: github.event_name != 'pull_request'   # push only on branch pushes; skip for PRs
    permissions:
      contents: read
      packages: write
      # to push to GHCR with GITHUB_TOKEN, repo permissions must allow packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GHCR
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}   # or use GHCR_PAT secret if preferred

      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/tactical-legends:${{ github.sha }}
            ghcr.io/${{ github.repository_owner }}/tactical-legends:latest
          platforms: linux/amd64,linux/arm64

      - name: Upload image metadata (artifact)
        uses: actions/upload-artifact@v4
        with:
          name: docker-tags
          path: |
            ./image-tags.txt
        continue-on-error: true

###############################################################################
# 6) SEMANTIC-RELEASE: runs only on main branch on push (publishes releases)
#    Requires: NPM_TOKEN (for npm publish) and GITHUB_TOKEN (already provided)
###############################################################################
  release:
    name: semantic-release (npm + GitHub Releases)
    runs-on: ubuntu-latest
    needs: [node]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      packages: write
      issues: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Install release tooling
        run: |
          npm ci
          npm install --no-save semantic-release @semantic-release/git @semantic-release/github || true

      - name: Run semantic-release
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          npx semantic-release

###############################################################################
# 7) GITHUB PAGES DEPLOY (for Node static site in node/dist)
#    Uses peaceiris/actions-gh-pages
#    Requires gh-pages permission on the repo
###############################################################################
  pages-deploy:
    name: Deploy Node site to GitHub Pages
    runs-on: ubuntu-latest
    needs: node
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
      - name: Download build artifact (node-dist)
        uses: actions/download-artifact@v4
        with:
          name: node-dist
          path: ./node-dist
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          publish_dir: ./node-dist
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # optionally configure cname:
          # cname: "docs.example.com"

###############################################################################
# 8) CODEQL: Security SAST scan
###############################################################################
  codeql-scan:
    name: CodeQL / SAST scan
    runs-on: ubuntu-latest
    permissions:
      actions: read
      security-events: write
    steps:
      - uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript,python,go
          # add queries if you use advanced rules
          # queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v2

      - name: Run CodeQL analysis
        uses: github/codeql-action/analyze@v2

###############################################################################
# 9) PRE-COMMIT / FORMAT CHECK (optional job to block PRs with format issues)
###############################################################################
  precommit:
    name: pre-commit checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install pre-commit
        uses: pre-commit/action@v4
        with:
          extra_args: --all-files

###############################################################################
# 10) SUMMARY / Notifications
###############################################################################
  done:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [python, go, node, docker, release, pages-deploy, codeql-scan]
    if: always()
    steps:
      - name: CI finished
        run: |
          echo "All CI jobs completed. Check job logs for details."
    
